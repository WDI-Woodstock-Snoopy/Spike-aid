<html>
  <head>
    <title>AOKs</title>

    <!-- jQuery and Google Maps -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>


  </head>
  <body>

    <form class="AOKs" action="index.html" method="post">
      <input type="text" name="helper[message]" placeholder="...message">
      <input type="submit" name="submit" value="Post">
    </form>

    <div id="cards-view">
    </div>

    <div class="sidebar" id="main-sidebar">
      <div class="sidebar" id="my-rank">
      </div>

      <!-- <div class="sidebar" id="map-view"-->
        <!-- user data input form -->
        <div id="search">
        <input id="address" type="textbox" value="Chicago, IL" placeholder=" Search Location">
        <input type="button" value="Enter Address" onclick="codeAddress()">
        </div> -->

        <!-- map -->
        <div id="map" style="width: 500px; height: 400px;"></div>
        <div class="sidebar" id="map"></div>
      </div>
    </div>



    <script>
    console.log("map loaded!")
    var map

    function initializeMap(){
    var defaultCenter = new google.maps.LatLng(41.893974, -87.627945);

    var defaultOptions = {
      zoom: 14,
      center: defaultCenter,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }

    map = new google.maps.Map(document.getElementById('map'), defaultOptions);

    var locations = [];
    var marker;

    $.ajax({
        method: 'get',
        url: 'https://data.cityofchicago.org/resource/uh4d-zh38?$$app_token=Prn58WX99dW48gNx4RtzbOjIy', //this should be replaced with an internal api to the DB
        dataType: 'json'
        })
        .done(function(data){
          for(var i=0; i<data.length; i++){
            locations.push(data[i]);
          };
          for (var i = 0; i < locations.length; i++) {
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(locations[i].latitude, locations[i].longitude),
              map: map
            });
            google.maps.event.addListener(marker, 'click', (function(marker, i) {
              return function() {
                infowindow.setContent(locations[i][0]);
                infowindow.open(map, marker);
              }
            })(marker, i));
          };
      });

      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var pos = new google.maps.LatLng(position.coords.latitude,
                                           position.coords.longitude);

          var infowindow = new google.maps.InfoWindow({
            map: map,
            position: pos,
            content: 'Location found using HTML5.'
          });

          map.setCenter(pos);
        }, function() {
          handleNoGeolocation(true);
        });
      } else {
        // Browser doesn't support Geolocation
        handleNoGeolocation(false);
      }


      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          var content = 'Please turn on Location Services.';
        } else {
          var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
          map: map,
          position: defaultCenter,
          content: content
        };

        var infowindow = new google.maps.InfoWindow(options);
        map.setCenter(options.position);
      }
    }

      var geocoder = new google.maps.Geocoder();

      function codeAddress() {
        var address = document.getElementById("address").value;
        geocoder.geocode( { 'address': address}, function(results, status) {
          console.log(results[0].geometry.location);
          if (status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);
            map.setZoom(16);
            var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                image: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
          } else {
            alert("Geocode was not successful for the following reason: " + status);
          }
        });
      }

    google.maps.event.addDomListener(window, 'load', initializeMap);

    </script>

  </body>
</html>
